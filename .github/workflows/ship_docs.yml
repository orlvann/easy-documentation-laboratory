name: Ship Docs
on: [push]

jobs:
  build-and-ship:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - run: pip install requests

      - name: Update ClickUp
        env:
          CLICKUP_TOKEN: ${{ secrets.CLICKUP_TOKEN }}
        run: python scripts/process_docs.py

      - name: Ship to Portal
        env:
          DEST_TOKEN: ${{ secrets.DOCS_PORTAL_PAT }}
        run: |
          # 1. Get the 7-character ID
          SHA_SHORT=$(git rev-parse --short HEAD)

          # 2. Setup Portal Repo
          git clone https://x-access-token:${DEST_TOKEN}@github.com/orlvann/Company-Docs-Portal.git portal
          cd portal

          # 3. Create the EXACT folder ClickUp is looking for
          mkdir -p features/$SHA_SHORT

          # 4. Copy the file into that folder
          cp ../docs/requirements.md features/$SHA_SHORT/requirements.md

          # 5. Create the index.html inside that SAME folder
          cat <<EOF > features/$SHA_SHORT/index.html
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>Spec Reader</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
          </head>
          <body class="markdown-body" style="padding: 45px;">
              <div id="content">‚è≥ Syncing with GitHub... (Wait 30 seconds)</div>
              <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/lib/marked.umd.min.js"></script>
              <script>
                  async function load() {
                      try {
                          const r = await fetch('requirements.md');
                          if (!r.ok) throw new Error("GitHub Pages is still building. Refresh in 30 seconds.");
                          const t = await r.text();
                          document.getElementById('content').innerHTML = marked.parse(t);
                      } catch (e) {
                          setTimeout(load, 5000); 
                      }
                  }
                  load();
              </script>
          </body>
          </html>
          EOF

          # 6. Push to the Portal
          git config user.name "Robot"
          git config user.email "robot@orlvann.com"
          git add .
          git commit -m "docs: release version $SHA_SHORT"
          git push
