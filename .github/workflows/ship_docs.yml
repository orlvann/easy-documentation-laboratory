name: Ship Docs
on: [push]

jobs:
  build-and-ship:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - run: pip install requests

      - name: Update ClickUp
        env:
          CLICKUP_TOKEN: ${{ secrets.CLICKUP_TOKEN }}
        run: python scripts/process_docs.py

      - name: Ship to Portal
        env:
          DEST_TOKEN: ${{ secrets.DOCS_PORTAL_PAT }}
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          TARGET_DIR="features/$SHA_SHORT"

          # Save the current directory for copying
          WORKSPACE_DIR=$(pwd)

          # Clone the portal repo
          git clone https://x-access-token:${DEST_TOKEN}@github.com/orlvann/Company-Docs-Portal.git portal
          cd portal

          git config user.name "Bot"
          git config user.email "bot@orlvann.com"

          # Disable Jekyll so GitHub Pages serves everything under features/
          touch .nojekyll

          # Prepare the feature directory and copy documentation
          mkdir -p "${TARGET_DIR}"
          cp "${WORKSPACE_DIR}/docs/requirements.md" "${TARGET_DIR}/index.md"

          # Simple HTML wrapper to render the Markdown file
          cat > "${TARGET_DIR}/index.html" <<'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>Documentation</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
              <style>
                  .markdown-body { padding: 45px; max-width: 980px; margin: 0 auto; }
                  .loading { text-align: center; padding: 100px; color: #666; }
              </style>
          </head>
          <body class="markdown-body">
              <div id="content" class="loading">‚è≥ Loading documentation...</div>
              <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/lib/marked.umd.min.js"></script>
              <script>
                  async function load() {
                      try {
                          const response = await fetch('index.md');
                          if (!response.ok) throw new Error('Not found');
                          const markdown = await response.text();
                          document.getElementById('content').innerHTML = marked.parse(markdown);
                      } catch (error) {
                          document.getElementById('content').innerHTML =
                              '<h1>Error Loading Documentation</h1><p>File not found.</p>';
                      }
                  }
                  load();
              </script>
          </body>
          </html>
          HTMLEOF

          # Commit and push changes
          git add -A
          git commit -m "docs: release ${SHA_SHORT}"
          git push origin main

      - name: Trigger Pages Build
        run: |
          # Trigger GitHub Pages rebuild
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DOCS_PORTAL_PAT }}" \
            https://api.github.com/repos/orlvann/Company-Docs-Portal/pages/builds
          echo "‚úÖ Pages build triggered!"
          echo "üìÑ Your docs will be available in 1‚Äì2 minutes at:"
          echo "https://orlvann.github.io/Company-Docs-Portal/features/${SHA_SHORT}/"
