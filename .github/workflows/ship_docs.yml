name: Ship Docs
on:
  push:

jobs:
  build-and-ship:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: python -m pip install --upgrade pip requests

      - name: Compute vars
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Update ClickUp
        env:
          CLICKUP_TOKEN: ${{ secrets.CLICKUP_TOKEN }}
        run: python scripts/process_docs.py

      - name: Ship to Portal
        env:
          DEST_TOKEN: ${{ secrets.DOCS_PORTAL_PAT }}
          SHA_SHORT: ${{ steps.vars.outputs.sha_short }}
        shell: bash
        run: |
          set -euo pipefail

          TARGET_DIR="features/${SHA_SHORT}"
          WORKSPACE_DIR="$(pwd)"

          git clone "https://x-access-token:${DEST_TOKEN}@github.com/orlvann/Company-Docs-Portal.git" portal
          cd portal

          git config user.name "Bot"
          git config user.email "bot@orlvann.com"

          # Disable Jekyll so GitHub Pages serves everything under features/
          touch .nojekyll

          mkdir -p "${TARGET_DIR}"
          cp "${WORKSPACE_DIR}/docs/requirements.md" "${TARGET_DIR}/index.md"

          cat > "${TARGET_DIR}/index.html" <<'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>Documentation</title>

              <!-- GitHub-like typography -->
              <link
                rel="stylesheet"
                href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css"
              />

              <style>
                body {
                  min-height: 100vh;
                  margin: 0;
                  background: linear-gradient(135deg, #ffe6f0 0%, #e6f0ff 100%);
                }

                .markdown-body {
                  padding: 45px;
                  max-width: 980px;
                  margin: 0 auto;
                  background: rgba(255, 255, 255, 0.85);
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
                  border-radius: 10px;
                }

                .loading {
                  text-align: center;
                  padding: 100px;
                  color: #666;
                }
              </style>
            </head>

            <body>
              <div id="content" class="markdown-body loading">‚è≥ Loading documentation...</div>

              <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/lib/marked.umd.min.js"></script>
              <script>
                async function load() {
                  try {
                    const response = await fetch("index.md", { cache: "no-store" });
                    if (!response.ok) throw new Error("Not found");
                    const markdown = await response.text();
                    document.getElementById("content").classList.remove("loading");
                    document.getElementById("content").innerHTML = marked.parse(markdown);
                  } catch (error) {
                    document.getElementById("content").innerHTML =
                      "<h1>Error Loading Documentation</h1><p>File not found.</p>";
                  }
                }
                load();
              </script>
            </body>
          </html>
          HTMLEOF

          git add -A

          # Don't fail the workflow if there are no changes
          git commit -m "docs: release ${SHA_SHORT}" || echo "No changes to commit."

          git push origin main

      - name: Trigger Pages Build
        env:
          DEST_TOKEN: ${{ secrets.DOCS_PORTAL_PAT }}
          SHA_SHORT: ${{ steps.vars.outputs.sha_short }}
        shell: bash
        run: |
          set -euo pipefail

          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${DEST_TOKEN}" \
            "https://api.github.com/repos/orlvann/Company-Docs-Portal/pages/builds"

          echo "‚úÖ Pages build triggered!"
          echo "üìÑ Your docs will be available at:"
          echo "https://orlvann.github.io/Company-Docs-Portal/features/${SHA_SHORT}/"
